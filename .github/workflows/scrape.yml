name: Cigro Data Scraping

on:
  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ 20ë¶„ (í•œêµ­ì‹œê°„)ì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '20 22 * * *'  # UTC ê¸°ì¤€ 22:20 (í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ 20ë¶„)
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      start_date:
        description: 'ì‹œì‘ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹, ë¹„ì›Œë‘ë©´ ì–´ì œ ë‚ ì§œ)'
        required: false
        type: string
      end_date:
        description: 'ì¢…ë£Œ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹, ë¹„ì›Œë‘ë©´ ì‹œì‘ ë‚ ì§œì™€ ë™ì¼)'
        required: false
        type: string
      brands:
        description: 'ìŠ¤í¬ë˜í•‘í•  ë¸Œëœë“œ ëª©ë¡ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„, ë¹„ì›Œë‘ë©´ ëª¨ë“  ë¸Œëœë“œ)'
        required: false
        type: string

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Cache Playwright browsers
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

    - name: Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: playwright install chromium --with-deps

    - name: Install Playwright deps only
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: playwright install-deps chromium
        
    - name: Create Google Sheets credentials
      env:
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
      run: |
        # JSON íŒŒì¼ ìƒì„± (í™˜ê²½ë³€ìˆ˜ì—ì„œ)
        echo "$GOOGLE_SHEETS_CREDENTIALS" > google_sheet_credentials.json

        # JSON í˜•ì‹ ê²€ì¦
        python3 -c "
        import json
        import sys
        try:
            with open('google_sheet_credentials.json', 'r') as f:
                data = json.load(f)
            print('âœ… JSON í˜•ì‹ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤.')
            print(f'âœ… í”„ë¡œì íŠ¸ ID: {data.get(\"project_id\", \"N/A\")}')
        except json.JSONDecodeError as e:
            print(f'âŒ JSON íŒŒì‹± ì˜¤ë¥˜: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âŒ ê¸°íƒ€ ì˜¤ë¥˜: {e}')
            sys.exit(1)
        "
        
    - name: Run scraping script
      env:
        EMAIL: ${{ secrets.CIGRO_EMAIL }}
        PASSWORD: ${{ secrets.CIGRO_PASSWORD }}
        GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
      run: |
        # ì•ˆì „í•œ ëª…ë ¹ì–´ ì‹¤í–‰ (eval ì‚¬ìš© ì•ˆí•¨)
        ARGS=""

        # ì‹œì‘ ë‚ ì§œ ì„¤ì •
        if [ -n "${{ github.event.inputs.start_date }}" ]; then
          echo "ì‹œì‘ ë‚ ì§œ: ${{ github.event.inputs.start_date }}"
          ARGS="$ARGS --start-date ${{ github.event.inputs.start_date }}"

          # ì¢…ë£Œ ë‚ ì§œ ì„¤ì •
          if [ -n "${{ github.event.inputs.end_date }}" ]; then
            echo "ì¢…ë£Œ ë‚ ì§œ: ${{ github.event.inputs.end_date }}"
            ARGS="$ARGS --end-date ${{ github.event.inputs.end_date }}"
          fi
        else
          echo "ì–´ì œ ë‚ ì§œë¡œ ìŠ¤í¬ë˜í•‘"
        fi

        # ë¸Œëœë“œ ì„¤ì •
        if [ -n "${{ github.event.inputs.brands }}" ]; then
          echo "ì„ íƒëœ ë¸Œëœë“œ: ${{ github.event.inputs.brands }}"
          ARGS="$ARGS --brands ${{ github.event.inputs.brands }}"
        else
          echo "ëª¨ë“  ë¸Œëœë“œ ìŠ¤í¬ë˜í•‘"
        fi

        echo "ì‹¤í–‰ ëª…ë ¹ì–´: python cigro_yesterday.py $ARGS"
        python cigro_yesterday.py $ARGS
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scraping-logs
        path: |
          *.log
          auth.json
        retention-days: 7
        
    - name: Send notification on success
      if: success()
      run: |
        echo "âœ… Cigro ë°ì´í„° ìŠ¤í¬ë˜í•‘ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸ“Š ë°ì´í„°ê°€ Google Sheetsì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
        
    - name: Send notification on failure
      if: failure()
      run: |
        echo "âŒ Cigro ë°ì´í„° ìŠ¤í¬ë˜í•‘ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”."
